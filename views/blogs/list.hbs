{{#section 'head'}}
    <!-- we want Google to ignore this purl -->
    <meta name="robots" content="noindex">
    <link rel="stylesheet" href="vendor/datatables.net-bs/css/dataTables.bootstrap.min.css">
    
{{/section}}


<section class="content">
    <button type="button" data-toggle="modal" data-target="#addModal">增加</button>&nbsp;&nbsp;&nbsp;<button type="button">删除</button>
    <table id="example" class="table table-striped table-bordered" cellspacing="0" width="100%"></table>
</section>
<div class="modal fade" id="addModal" tabindex="-1" role="dialog" aria-labelledby="addModal">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span
                        aria-hidden="true">&times;</span></button>
                <h4 class="modal-title" id="myModalLabel">Add</h4>
            </div>
            <div class="modal-body">
                <form class="form-horizontal" name="addForm" id="addForm" action="" method="POST">
                    <div class="form-group">
                        <label for="comment" class="col-sm-2 control-label">comment</label>
                        <div class="col-sm-10">
                            <input type="text" name="comment" class="form-control" id="addcomment" placeholder="class title">
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="title" class="col-sm-2 control-label">title</label>
                        <div class="col-sm-10">
                            <input type="text" name="title" class="form-control" id="addtitle" placeholder="title">
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="content" class="col-sm-2 control-label">content</label>
                        <div class="col-sm-10">
                            <input type="text" name="content" class="form-control" id="addcontent" placeholder="content">
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="author" class="col-sm-2 control-label">author</label>
                        <div class="col-sm-10">
                            <input type="text" name="author" class="form-control" id="addauthor" placeholder="author">
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="col-sm-2 control-label">isShow</label>
                        <div class="col-sm-10">
                            <label>
                                <input type="radio" name="isShow" id="addyes" value="1">是
                            </label>
                            <label>
                                <input type="radio" name="isShow" id="addno" value="0" checked>否
                            </label>
                        </div>
                    </div>
                    <!--<div class="form-group">
                        <label for="createdAt" class="col-sm-2 control-label">createdAt</label>
                        <div class="col-sm-10">
                            <input type="createdAt" name="createdAt" class="form-control" id="createdAt" placeholder="createdAt">
                        </div>
                    </div>-->
                    <div class="modal-footer">
                        <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
                        <button type="button" class="btn btn-primary" onclick="validatorAddProFile()">Confirm</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>
<!--编辑-->
<div class="modal fade" id="editModal" tabindex="-1" role="dialog" aria-labelledby="editModal">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span
                        aria-hidden="true">&times;</span></button>
                <h4 class="modal-title" id="myModalLabel">Edit</h4>
            </div>
            <div class="modal-body">
                <form class="form-horizontal" name="editForm" id="editForm" action="" method="POST">
                    <div class="form-group">
                        <label for="comment" class="col-sm-2 control-label">comment</label>
                        <div class="col-sm-10">
                            <input type="text" name="comment" class="form-control" id="comment" placeholder="class title">
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="title" class="col-sm-2 control-label">title</label>
                        <div class="col-sm-10">
                            <input type="text" name="title" class="form-control" id="title" placeholder="title">
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="content" class="col-sm-2 control-label">content</label>
                        <div class="col-sm-10">
                            <input type="text" name="content" class="form-control" id="content" placeholder="content">
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="author" class="col-sm-2 control-label">author</label>
                        <div class="col-sm-10">
                            <input type="text" name="author" class="form-control" id="author" placeholder="author">
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="col-sm-2 control-label">isShow</label>
                        <div class="col-sm-10">
                            <label>
                                <input type="radio" name="isShow" id="yes" value="1">是
                            </label>
                            <label>
                                <input type="radio" name="isShow" id="no" value="0">否
                            </label>
                        </div>
                    </div>
                    <!--<div class="form-group">
                        <label for="createdAt" class="col-sm-2 control-label">createdAt</label>
                        <div class="col-sm-10">
                            <input type="createdAt" name="createdAt" class="form-control" id="createdAt" placeholder="createdAt">
                        </div>
                    </div>-->
                    <div class="modal-footer">
                        <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
                        <button type="button" class="btn btn-primary" data-dismiss="modal" onclick="validatorProFile()">Confirm</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>
<div class="modal fade" id="deleteModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                <h4 class="modal-title" id="myModalLabel">Delete</h4>
            </div>
            <form class="form-horizontal modal-body" name="confirmDelete" action="" method="POST">
                <p class="alert alert-danger" style="display: block">
                    Are you sure to delete this data?
                    <input type="hidden" name="uid" id="uid">
                </p>
                <div class="modal-footer">
                    <button type="button" class="btn btn-default" data-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-danger" onclick="delData()">Confirm</button>
                </div>
            </form>
        </div>
    </div>
</div>
{{#section 'customjs'}}
    <script src="vendor/datatables.net/js/jquery.dataTables.min.js"></script>
    <script src="vendor/datatables.net-bs/js/dataTables.bootstrap.min.js"></script>
    <script>
        //文档就绪事件
        $(document).ready(function () {
            getBlogsList();
        });
        function getBlogsList() {
            var para  ='';
            $.ajax({
                url:'/blog/get-blogs-list',
                type: 'POST',
                async:true,
                data:para,
                success: function(res)
                {
                    if(parseInt(res.code) == 1) {
                        var _blogsSet = getBlogsArr(res.blogs);
                        renderTable(_blogsSet);
                        var $td = $("td");
                        for(let i = 0; i < $td.length; i++) {
                            if($td.eq(i).text().length >100) {
                                $td.eq(i).text($td.eq(i).text().slice(0,100) + "...");
                            }
                        }
                    }
                }
            });
        }
        //构造取得的数据
        function getBlogsArr(blogsSet) {
            var _blogsArr = blogsSet;
            var jsoncount =_blogsArr.length;
            var blogsData =  new Array();
            for(var i=0;i<jsoncount;i++)
            {
                var _arr = new Array();
                _arr[0]='<input type="checkbox">';
                _arr[1]= _blogsArr[i].comment.num;
                _arr[2]= _blogsArr[i].title;
                _arr[3]= _blogsArr[i].content;
                _arr[4]= _blogsArr[i].author;
                if(parseInt(_blogsArr[i].isShow)==1)
                {
                    _arr[5]= "是";
                }
                if(parseInt(_blogsArr[i].isShow)==0)
                {
                    _arr[5]= "否";
                }
                _arr[6]= _blogsArr[i].createdAt;
                _arr[7]= '<button class="btn btn-default btn-sm" \
			 data-toggle="modal" data-target="#editModal" onclick="edit(\''+_blogsArr[i]._id+'\')"> \
			 <span class="glyphicon glyphicon-pencil"></span> \
		  </button>  \
		<button class="btn btn-danger btn-sm" data-toggle="modal" \
		 data-target="#deleteModal" onclick="edit(\''+_blogsArr[i]._id+'\')"> \
		<span class="glyphicon glyphicon-trash"></span> \
	</button>';
                blogsData[i]=_arr;
            }
            console.log(blogsData);
            return blogsData;
        }
        //渲染数据
        function renderTable(blogsSet) {
            $('#example').DataTable( {
                data:blogsSet,
                columns: [
                    { title:'<input type="checkbox">',orderable: false},
                    { title: "comment" },
                    { title: "title" }, 
                    { title: "content" },
                    { title: "author" },
                    { title: "isShow" },
                    { title: "createAt"},
                    { title: "操作",orderable: false }
                ]
            } );
        }
        /* 编辑事件 */
        function edit(id) {
            $("#uid").val(id);
            var para = $("#editForm").serialize();
            $.ajax({
                url:"/blogs/show-blogs/"+id,
                type:"GET",
                async:true,
                data:para,
                success:function (res) {
                    console.log(res);
                    if(parseInt(res.blogs[0].isShow) === 0) {
                        $("#no").attr("checked", "checked");
                    }
                    if(parseInt(res.blogs[0].isShow) === 1) {
                        $("#yes").attr("checked", "checked");
                    }
                    $("#comment").val(res.blogs[0].comment);
                    $("#author").val(res.blogs[0].author);
                    $("#createdAt").val(res.blogs[0].createdAt);
                    $("#title").val(res.blogs[0].title);
                    $("#content").val(res.blogs[0].content);
                }
            })
        }
        function validatorAddProFile() {
            var ret = true;
            if (!validator.isLength($("#addcomment").val(), {min: 1, max: 20})) {
                ret = false;
                alert("The comment should be between 1 and 20 letters");
                $("#addcomment").focus();
                $("#pwdWarning").css("display","block");
                return false;
            }
            if (!validator.isLength($("#addtitle").val(), {min: 2, max: 20})) {
                ret = false;
                alert("The title should be between 4 and 20 letters");
                $("#addtitle").focus();
                $("#addpwdWarning").css("display","block");
                return false;
            }
            if (!validator.isLength($("#addcontent").val(), {min: 1, max: 1000})) {
                ret = false;
                alert("The content should not be empty");
                $("#addcontent").focus();
                $("#pwdWarning").css("display","block");
                return false;
            }
            if (!validator.isLength($("#addauthor").val(), {min: 1, max: 1000})) {
                ret = false;
                alert("The author should not be empty");
                $("#addauthor").focus();
                $("#pwdWarning").css("display","block");
                return false;
            }
            if (ret) {
                cmsUpload();
            }
        }
        function validatorProFile() {
            var ret = true;
            if (!validator.isLength($("#comment").val(), {min: 2, max: 20})) {
                ret = false;
                alert("The comment should be between 2 and 20 letters");
                $("#comment").focus();
                $("#pwdWarning").css("display","block");
                return false;
            }
            if (!validator.isLength($("#title").val(), {min: 2, max: 20})) {
                ret = false;
                alert("The title should be between 4 and 20 letters");
                $("#title").focus();
                $("#pwdWarning").css("display","block");
                return false;
            }
            if (!validator.isLength($("#content").val(), {min: 1, max: 1000})) {
                ret = false;
                alert("The content should not be empty");
                $("#content").focus();
                $("#pwdWarning").css("display","block");
                return false;
            }

            if (ret) {
                saveProfile();
            }
        }
        function delData() {
            $.ajax({
                url: "/users/delete-cms/" + $("#uid").val(),
                type: "POST",
                async: true,
                data: "",
                success: function (res) {
                    if (parseInt(res.code) === 0) {

                    }
                    else if (parseInt(res.code) === 1) {
                        console.log(res);
                        window.location.href = "/users/list-2"
                    }
                }
            })
        }
        function cmsUpload() {
            var para = $("#addForm").serialize();
            console.log(para);
            $.ajax({
                url: 'users/cms',
                type: 'POST',
                async: true,
                data: para,
                success: function (res) {
                    if(parseInt(res.code) === 0) {
                        alert("failed");
                    }
                    else if(parseInt(res.code) === 1) {
                        alert(res.msg);
                        console.log(res);
                        window.location.href = "/users/list-2";
                    }
                }
            });
            /*alert(para);*/
        }
        function saveProfile() {
            var para = $("#editForm").serialize();
            console.log(para);
            $.ajax({
                url: "/users/save-cms",
                type: "POST",
                async: true,
                data: para,
                success: function (res) {
                    if (parseInt(res.code) === 0) {

                    }
                    else if (parseInt(res.code) === 1) {
                        console.log(res);
                        window.location.href = "/users/list-2"
                    }
                }
            })
        }
    </script>
{{/section}}